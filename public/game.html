<!DOCTYPE html>
<html>

<head>
	<title>Virtual Kings</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="/socket.io/socket.io.js"></script>
<script>
var channelID = window.location.pathname.replace(/\/game\//, '');
var url_string = window.location.href;
var url = new URL(url_string);
var username = url.searchParams.get("username");
var socket = io();

socket.emit('mailman', '{"method" : "game_play", "payload" : {"channelID" : "'+channelID+'"}}')

socket.on('messages', function(data) {
	var data = JSON.parse(data)

	var method = data.method

	// initial signal
  if (method == 'game_play') {
  	document.getElementById('player-count').innerHTML = data.payload.number_players
  	document.getElementById('current-player').innerHTML = data.payload.next_player
  	// disable get card if not turn yet
  	if (data.payload.next_player != username) {
  		document.getElementById('card-button').disabled = true
  	} else {
  		document.getElementById('card-button').disabled = false
  	}
  } 
  	// during gameplay
  else if (method == 'card_play') {
  	document.getElementById('current-player').innerHTML = data.payload.next_player
  	document.getElementById('card-div').innerHTML = data.payload.card
  	getCardImage(data.payload.card)
  	// disable get card if not turn yet
  	if (data.payload.next_player != username) {
  		document.getElementById('card-button').disabled = true
  	} else {
  		document.getElementById('card-button').disabled = false
  	}
  }

})

// send signal that the player just played a card
function sendCardPlay() {
	socket.emit('mailman', '{"method" : "card_play", "payload" : {"channelID" : "' + channelID + '"}}')
}

function getCardImage(card) {
	// var xhr = new XMLHttpRequest();

	document.getElementById('card-content').src='/card_image/'+card

    // xhr.onreadystatechange = function() {
    //   console.log('getting card image');
    //   if (this.readyState == 4 && this.status == 200) {
    //     document.getElementById('card').setAttribute('src', "data:image/png;base64," + this.response)
    //     console.log(this.response)
    //     document.getElementById('card-div').innerHTML(this.responseText)
    //   }
    // }
    // xhr.open("GET", "/card_image/" + card, true);
    // xhr.setRequestHeader("Content-Type", "application/json");
    // xhr.send(JSON.stringify({card: card}));
  }


document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('roomCode').innerHTML = channelID
}); 

</script>

</head>

<body>
<div class="wrapper">
	<div class="header">
		<div class="room-info">
			<div class="info">Room name: <span id="roomCode"></span> </div>
			<div class="info"><span id="player-count"></span> people in the room</div>
			<div class="info"><span id="current-player"></span> to play </div>
		</div>
	</div>

	<div class="play-area">
		<button id="card-button" onclick='sendCardPlay();'> Play a card </button>
		<div class="main-area">
			<div id="card-div">
			</div>
			<img id="card-content" src='/card_image/gray_back' />
		</div>
	</div>
</div>
</body>
</html>